---
import Inputmask from "inputmask";
import toastr from "toastr";
---

<div class="md:max-w-2xl mx-auto bg-white px-2 py-8 xs:px-6 md:px-16 md:py-12">
  <h1 class="text-xl lg:text-2xl xl:text-3xl font-bold uppercase font-display italic">Оплатить заказ</h1>
  <p class="text-sm text-secondary mb-5">
    Пожалуйста, перед оплатой согласуйте сумму с отделом продаж
  </p>
  <form id="paymentForm" class="flex flex-col gap-5">
    <div class="flex flex-col gap-3">
      <input
        class="form__input form__input--tel"
        type="tel"
        name="tel"
        id="paymentTel"
        required
        placeholder="Номер телефона"
      />
      <input
        class="form__input form__input--name"
        type="text"
        name="name"
        id="paymentName"
        required
        placeholder="Ваше ФИО"
      />
      <input
      class="form__input form__input--email"
      type="email"
      name="email"
      id="paymentEmail"
      required
      placeholder="Электронная почта"
    />

      <div class="form__select-wrapper">
        <select name="recipient" id="recipient-select" class="form__select">
          <option value="" selected disabled hidden>Кому</option>
          <option value="Self">Себе</option>
          <option value="Gift">В подарок</option>
        </select>
      </div>

      <!-- Скрытое поле для ФИО получателя -->
      <input
        class="form__input form__input--name"
        type="text"
        name="giftName"
        id="giftName"
        style="display:none;"
        placeholder="ФИО получателя"
      />


      <input
        class="form__input form__input--value"
        type="number"
        step="0.01"
        name="amount"
        id="paymentAmount"
        required
        placeholder="Сумма оплаты"
      />
    </div>
    <div class="flex flex-col gap-1">
      <button
        type="submit"
        class="form__submit text-sm bg-accent text-white flex justify-center items-center h-[60px] min-w-[300px] xl:min-w-[350px] transition hover:shadow-button hover:shadow-accent"
      >
        Оплатить заказ
      </button>
      <span class="text-sm text-secondary"
        >Нажимая кнопку вы даете согласие на
        <a class="text-accent underline" href="/privacy">обработку данных</a
        ><br /><a class="text-accent underline" href="/gift"
          >Оказание услуг по контраварийному вождению</a
        ><br /><a class="text-accent underline" href="/gift-track"
          >Оказания услуг на гоночном треке</a
        ></span
      >
    </div>
  </form>
</div>

<style>
    .form__select {
        @apply pl-7 pr-5 h-7 text-sm bg-no-repeat bg-input text-secondary bg-[#ebebeb] border border-solid border-white appearance-none w-full;
        background-image: url("data:image/svg+xml,%3Csvg width='20' height='25' viewBox='0 0 20 25' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cg clip-path='url(%23clip0_787_40)'%3E%3Cpath d='M7.68026 1.04574V2.0813C7.67986 2.21089 7.63136 2.33572 7.54415 2.43158C7.45693 2.52744 7.33723 2.58749 7.20825 2.6001C7.14831 2.61857 7.08583 2.62749 7.02311 2.62655H5.1005V4.77295H14.7766V2.62655H12.852C12.7893 2.62729 12.7268 2.61837 12.6668 2.6001C12.5379 2.58749 12.4181 2.52744 12.3309 2.43158C12.2437 2.33572 12.1952 2.21089 12.1948 2.0813V1.04574H7.68026ZM14.3026 10.262C14.5768 10.2618 14.8484 10.3155 15.1018 10.4203C15.3553 10.525 15.5856 10.6786 15.7796 10.8724C16.0717 11.1647 16.2705 11.537 16.351 11.9422C16.4315 12.3475 16.39 12.7675 16.2318 13.1492C16.0736 13.5309 15.8058 13.8571 15.4622 14.0867C15.1186 14.3162 14.7147 14.4387 14.3016 14.4387C13.8884 14.4387 13.4845 14.3162 13.1409 14.0867C12.7973 13.8571 12.5295 13.5309 12.3713 13.1492C12.2131 12.7675 12.1717 12.3475 12.2521 11.9422C12.3326 11.537 12.5314 11.1647 12.8235 10.8724L12.8499 10.848C13.2385 10.4707 13.7589 10.2598 14.3005 10.26L14.3026 10.262ZM15.1611 11.4929C14.9359 11.2704 14.633 11.1441 14.3164 11.1407C13.9999 11.1373 13.6943 11.257 13.4644 11.4746L13.446 11.495C13.2737 11.665 13.1559 11.8825 13.1075 12.1197C13.0591 12.357 13.0824 12.6032 13.1743 12.8272C13.2662 13.0512 13.4227 13.2428 13.6238 13.3776C13.8248 13.5124 14.0615 13.5844 14.3036 13.5844C14.5457 13.5844 14.7823 13.5124 14.9834 13.3776C15.1845 13.2428 15.341 13.0512 15.4329 12.8272C15.5248 12.6032 15.5481 12.357 15.4997 12.1197C15.4513 11.8825 15.3334 11.665 15.1611 11.495V11.4929ZM9.59676 18.457L10.5367 17.922L10.0016 16.982L10.8826 16.4795L11.4156 17.4194L12.3556 16.8864L12.856 17.7673L11.9161 18.3105L12.4512 19.2505L11.5702 19.7347L11.0372 18.7968L10.0973 19.3278L9.59676 18.4489V18.457ZM3.21859 11.4726L4.15853 10.9395L3.62345 9.99959L4.50439 9.49911L5.03744 10.439L5.97738 9.90601L6.47786 10.7829L5.53792 11.3159L6.073 12.2559L5.19206 12.7563L4.65902 11.8184L3.71908 12.3535L3.21859 11.4726ZM6.51042 17.1427C6.83147 17.2192 7.11655 17.4035 7.31796 17.6649C7.51937 17.9264 7.6249 18.249 7.6169 18.579C7.60889 18.9089 7.48783 19.2261 7.27397 19.4774C7.06011 19.7288 6.76643 19.8991 6.44204 19.9598C6.11766 20.0206 5.78225 19.9681 5.49193 19.8112C5.2016 19.6542 4.97397 19.4024 4.84712 19.0977C4.72027 18.793 4.70188 18.454 4.79504 18.1374C4.88819 17.8208 5.08724 17.5458 5.35889 17.3584L5.40161 17.3299C5.36543 17.0296 5.35658 16.7265 5.37516 16.4246C5.42394 15.4467 5.79362 14.5121 6.427 13.7655C7.14721 12.9545 8.14095 12.4374 9.21834 12.3128C9.34855 12.2925 9.48486 12.2782 9.62524 12.2681L8.93555 11.6923L9.65576 10.8317L11.8937 12.6933L9.87549 14.7664L9.06169 13.9893L9.63949 13.3931C9.5459 13.3931 9.45435 13.4033 9.36483 13.4237C8.5939 13.4959 7.87608 13.8479 7.34685 14.4131C6.81762 14.9783 6.51358 15.7177 6.49211 16.4917C6.47859 16.7087 6.48336 16.9265 6.50635 17.1427H6.51042ZM6.60197 18.2434C6.52267 18.1303 6.40212 18.0529 6.26628 18.0278C6.1992 18.0153 6.13034 18.0163 6.06364 18.0306C5.99695 18.0449 5.93375 18.0723 5.87769 18.1112C5.76502 18.19 5.68763 18.3097 5.66203 18.4448C5.64937 18.5119 5.65023 18.5808 5.66455 18.6475C5.67887 18.7143 5.70638 18.7775 5.74544 18.8334C5.80416 18.9179 5.88657 18.9831 5.98229 19.0207C6.078 19.0584 6.18273 19.0669 6.28326 19.0451C6.3838 19.0234 6.47564 18.9723 6.5472 18.8985C6.61876 18.8246 6.66685 18.7311 6.68538 18.63C6.7097 18.4939 6.67976 18.3536 6.60197 18.2393V18.2434ZM4.84416 5.83293C4.63646 5.82999 4.43775 5.74774 4.28874 5.60303C4.27043 5.58268 4.26229 5.56437 4.24398 5.54606C4.12721 5.4059 4.06188 5.23001 4.05884 5.04761V3.99577H1.1556C1.13966 3.99537 1.12384 3.99865 1.10938 4.00535C1.09491 4.01206 1.08218 4.022 1.07218 4.03442C1.05119 4.05667 1.03829 4.08534 1.03556 4.1158V23.8342C1.03406 23.8501 1.03663 23.8661 1.04304 23.8807C1.04945 23.8953 1.05948 23.908 1.07218 23.9176C1.09422 23.9402 1.12411 23.9533 1.1556 23.9543H18.7174C18.7331 23.9542 18.7486 23.951 18.763 23.9447C18.7773 23.9384 18.7902 23.9292 18.8009 23.9176C18.8142 23.9085 18.8249 23.896 18.8317 23.8813C18.8385 23.8666 18.8412 23.8503 18.8395 23.8342V4.1158C18.8361 4.08512 18.8225 4.05648 18.8009 4.03442C18.7911 4.02176 18.7784 4.01163 18.7639 4.00491C18.7494 3.99818 18.7334 3.99504 18.7174 3.99577H15.8223V5.05168C15.8193 5.23408 15.754 5.40997 15.6372 5.55013C15.6189 5.56844 15.6087 5.58675 15.5904 5.6071C15.4428 5.75275 15.2444 5.83521 15.037 5.837L4.84416 5.83293ZM1.16577 25C0.856755 24.9995 0.560549 24.8765 0.342041 24.658C0.123533 24.4395 0.000537889 24.1432 0 23.8342L0 4.1158C0.00107241 3.80695 0.124239 3.51106 0.342631 3.29266C0.561024 3.07427 0.85692 2.95111 1.16577 2.95003H4.06901V2.37834C4.07008 2.16985 4.15338 1.9702 4.3008 1.82278C4.44823 1.67535 4.64787 1.59205 4.85636 1.59098H6.6508V0.868734C6.65161 0.755004 6.67485 0.642552 6.71919 0.537818C6.76352 0.433084 6.82809 0.338126 6.90918 0.258382C6.98892 0.17729 7.08388 0.112726 7.18862 0.0683881C7.29335 0.0240507 7.4058 0.000810959 7.51953 0L12.3617 0C12.4754 0.000475471 12.588 0.0235627 12.6928 0.0679197C12.7975 0.112277 12.8925 0.177019 12.972 0.258382C13.0537 0.337751 13.1189 0.432593 13.1636 0.537381C13.2083 0.64217 13.2317 0.754808 13.2324 0.868734V1.59098H15.0269C15.2352 1.59206 15.4346 1.67542 15.5817 1.8229C15.7288 1.97039 15.8116 2.17003 15.8122 2.37834V2.95003H18.7174C19.026 2.95216 19.3213 3.07567 19.5394 3.29383C19.7576 3.512 19.8811 3.80728 19.8832 4.1158V23.8342C19.8827 24.1432 19.7597 24.4395 19.5412 24.658C19.3227 24.8765 19.0265 24.9995 18.7174 25H1.16577Z' fill='%2346A6FF'/%3E%3C/g%3E%3Cdefs%3E%3CclipPath id='clip0_787_40'%3E%3Crect width='19.8771' height='25' fill='white'/%3E%3C/clipPath%3E%3C/defs%3E%3C/svg%3E%0A");  }
    .form__select-wrapper {
      width: 100%;
      position: relative;
    }
    .form__select-wrapper::after {
      position: absolute;
      content: "";
      display: block;
      top: calc(50% - 3px);
      right: 10px;
      width: 0;
      height: 0;
      border: 6px solid transparent;
      border-color: #46a6ff transparent transparent transparent;
    }
  </style>


<script client:load>
  const form = document.getElementById("paymentForm");
  const recipientSelect = document.getElementById("recipient-select");
  const giftNameInput = document.getElementById("giftName");

  // Обработчик для скрытого поля
  recipientSelect.addEventListener("change", function () {
    if (this.value === "Gift") {
      giftNameInput.style.display = "block";
      giftNameInput.required = true;
    } else {
      giftNameInput.style.display = "none";
      giftNameInput.required = false;
      giftNameInput.value = "";
    }
  });

  const telInput = document.getElementById("paymentTel");
  telInput.addEventListener("input", function (e) {
    var inputValue = e.target.value;
    var numberPattern = /^\d*$/;
    if (!numberPattern.test(inputValue)) {
      e.target.value = inputValue.replace(/\D/g, "");
    }
    if (inputValue.length > 20) {
      e.target.value = inputValue.slice(0, 20);
    }
  });

  form.onsubmit = async function (e) {
    e.preventDefault();
    const nameInput = document.getElementById("paymentName");
    const emailInput = document.getElementById("paymentEmail");
    const amountInput = document.getElementById("paymentAmount");

    if (
      [nameInput, emailInput, telInput, amountInput].every((input) =>
        input?.checkValidity()
      )
    ) {
      const description = `Ф.И.О: ${nameInput.value}, Телефон: ${telInput.value}, E-mail: ${emailInput.value}, Получатель: ${recipientSelect.value}${
        recipientSelect.value === "Gift"
          ? `, Ф.И.О получателя: ${giftNameInput.value}`
          : ""
      }`;
      const backUrl = "https://ratata.ru/";
      const data = new URLSearchParams();

      data.append("orderNumber", `${new Date().getTime()}`);
      data.append("description", description);
      data.append("returnUrl", `${backUrl}#payment_success`);
      data.append("failUrl", `${backUrl}#payment_error`);
      data.append("email", emailInput.value);
      data.append("amount", `${+amountInput.value}`);
      data.append("source", "ratata");
      const response = await fetch("https://autopragmat.ru/api/v2/send-pay/", {
        method: "POST",
        body: data,
      });
      if (!response.ok) {
        return;
      }
      let result = await response.json();
      if (result.errorCode || result.errorMessage) {
        toastr.error(result.errorMessage);
        return;
      }
      window.location.href = result.formUrl;
    }
  };
</script>

